---
title: "Calculatibg Coordinates"
author: "Edson Silva-Júnior"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Calculating coordinates based on Azimuth degrees and distances with R

In geospatial analysis, an useful tooç is calculate a geographic coordinate, using only [Azimuth degrees](https://en.wikipedia.org/wiki/Azimuth#:~:text=The%20azimuth%20is%20the%20angle%20between%20the%20north%20vector%20and,mapping%2C%20mining%2C%20and%20ballistics) and distances between the points. It is possible throught earth curvature and radius:

$$
\varphi_{2} = \varphi_{1} + \sin \left(\left(90 - \theta \right) * \frac{\pi}{180} \right) * d
$$

$$
\lambda_{2} = \lambda_{1} + \cos \left(\left(90 - \theta \right) * \frac{\pi}{180} \right) * d
$$

- $\varphi_{2}$: Final latitude;

- $\varphi_{2}$: Initial latitude;

- $\theta$: Azimuth degrees;

- $d$: distance;

- $\lambda_{2}$: Final longitude;

- $\lambda_{2}$: Initial longitude;

# Required packages

To calculate coordinates, we use the required packages:

- [readxl](https://readxl.tidyverse.org): to import our data;

- [tidyverse](https://tidyverse.tidyverse.org/): to transform and visualize data and run loop to calculate multiples coordinates;

- [geosphere](https://readxl.tidyverse.org): to calculate coordinates.

- [sf](https://r-spatial.github.io/sf): to transform table data into a shapefile.

```{r}
library(readxl)

library(tidyverse)

library(geosphere)

library(sf)
```

# Data 

## Importing

```{r}
coord <- readxl::read_xlsx("coordinates.xlsx")
```

## Visualizing

```{r}
coord |> as.data.frame()

coord |> dplyr::glimpse()
```

# Calculating coordinates 

## Creating a coordinates calculating function

As we wante to calculate to multiple rows, but rows valued as NA, we build a function that identify whether a row to longitude or latitude are NA, using `if(){}` conditional loop. `id` variable are a row identification, from 1 to rows count. Detecting a NA row, the function calculate coordinates, throught `geosphere::destPoint()` R function, where:

- p: coordinate, on idth row - 1 and 1st and 2nd column;

- b: Azimuth degree, on idth rowe - 1 and 3rd column;

- d: distance: on idth row - 1 and 4th column.

When a coordinate are calculated, longitude (`coordinate[1]`) and latitude (`coordinate[2]`) are aditioned to long and lat columns on its respective row.

```{r}
coord_calcule <- function(id){
  
  if(coord$long[id] |> is.na() | coord$lat[id] |> is.na()){
    
    coordinate <- geosphere::destPoint(p = coord[id - 1, 1:2],
                                       b = coord[id - 1, 3],
                                       d = coord[id - 1, 4])
    
    coord$long[id] <<- coordinate[1]
    
    coord$lat[id] <<- coordinate[2]
    
  }
  
}
```

## Executing loop

To execute a repeat loop, we use `walk()`, from `purrr` r package, firts informing the variable id and next the build function.

```{r}
purrr::walk(1:nrow(coord), coord_calcule)

coord |> as.data.frame()
```

## Converting to a shapefile 

```{r}
coord_sf <- coord |> 
  sf::st_as_sf(coords = c("long", "lat"),
               crs = 4674) |> 
  dplyr::summarise(do_union = FALSE) |> 
  sf::st_cast("LINESTRING")

coord_sf
```

## Visualizing as a map

```{r}
ggplot() +
  geom_sf(data = coord_sf)
```

